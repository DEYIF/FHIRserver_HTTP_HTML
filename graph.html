<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Today's heart rate</title>
</head>
<body>

    <div id="plot_area" style="width:1000px;height:350px;"></div>
    <div id="indicator_area" style="width:1000px;height:350px;"></div>

    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="jqFhir.js"></script>

    <script type="module">

      // Create plot (graph element)
      const plotly_elem = document.getElementById('plot_area');
      const plotly_layout = {
        margin: {t: 50},
        title: 'Heart Rate (BPM)',
        // grid: { rows: 1, columns: 2, pattern: "independent" },
        domain: { x: [0, 1], y: [0, 1] }, // Both grid and domain different ways of showing the final plot. For aesthetics we keep domain.
        xaxis: {title: 'Time'},
        yaxis: {title: 'Heart Rate (BPM)'},
      };
      var plotly_data = [
       { x: [], // Time on x-axis
        y: [], // BPM on y-axis
        type: 'scatter',
        mode: 'lines+markers',
        name: 'Heart Rate (BPM)',
        connectgaps: false
       }
      ];

       var client = jqFhir({ baseUrl: 'https://hapim.app.cloud.cbh.kth.se/fhir' });

      // Initialize plot (graph element)
      Plotly.newPlot(plotly_elem, plotly_data, plotly_layout);
       
      // Create indicator element
      const indicator_elem = document.getElementById('indicator_area');
      var default_value = 0;  // Initial default value for BPM
      var previous_value = default_value;  // Show also previous value in the indicator 
      var indicator_data = [
        {
          type: "indicator",
          mode: "number+delta",
          value: default_value,
          delta: { position: "top", reference: previous_value },
          title: { text: "Heart Rate (BPM)" },
          domain: { x: [0, 1], y: [0, 1] }
        }
      ];
      var indicator_layout = { 
        margin: { t: 50, r: 50, l: 50, b: 50 }
      };

      // Initialize indicator
      Plotly.newPlot(indicator_elem, indicator_data, indicator_layout);
      
       // Obtain information from FHIR database            
       const fhirEndpoint = "https://hapim.app.cloud.cbh.kth.se/fhir/Observation";
      const patientId = "1123"; // Add patient ID
      
      //let last_time = null; // Variable to track last time added

      async function fetchHeartRateData() {
        console.log("Fetching heart rate data...");
        try {
          const response = await fetch(`${fhirEndpoint}?patient=${patientId}&_count=20000000`, {
            headers: {
              "Accept": "application/fhir+json"
            }
          });
          
          if (response.ok) {
            const fhirData = await response.json();
            const observations = fhirData.entry || [];
            const heartRateData = [];

           // 提取心率数据并存储在数组中
           observations.forEach((entry) => {
              const observation = entry.resource;
              const BPM_value = observation.valueQuantity.value;  // Extract heart rate value
              const current_time = new Date(observation.effectiveInstant).getTime(); // 获取时间戳

              if (BPM_value !== undefined && current_time !== undefined) {
                heartRateData.push({ time: current_time, bpm: BPM_value }); // 将数据添加到数组中
                console.log("Heart Rate (BPM):", BPM_value, "at", new Date(current_time).toLocaleString());
              }
            });

            // 根据时间戳排序
            heartRateData.sort((a, b) => a.time - b.time);

            // 更新图表数据
            heartRateData.forEach(dataPoint => {
              const timeFormatted = new Date(dataPoint.time).toLocaleString(); // 格式化时间


              // Update the heart rate graph with new data
              Plotly.extendTraces(plotly_elem, {
                  x: [[timeFormatted]],
                  y: [[dataPoint.bpm]]
              }, [0]);

              // Update the number+delta indicator
              Plotly.update(indicator_elem, {
                  value: [dataPoint.bpm],
                  'delta.reference': [previous_value]
              }, [0]);

              // Update previous value
              previous_value = dataPoint.bpm;
            });

          } else {
            console.error("Error retrieving data from FHIR:", response.statusText);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // 定期获取数据
      setInterval(fetchHeartRateData, 10000);
      fetchHeartRateData();


    </script>
</body>
</html>
