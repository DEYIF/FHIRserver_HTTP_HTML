<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Today's heart rate</title>
</head>
<body>

    <div id="plot_area" style="width:1000px;height:350px;"></div>
    <div id="indicator_area" style="width:1000px;height:350px;"></div>

    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script type="module">

      // Initialize plotly (graph element)
      const plotly_elem = document.getElementById('plot_area');
      const plotly_layout = {
        margin: {t: 50},
        title: 'Heart Rate (BPM)',
        // grid: { rows: 1, columns: 2, pattern: "independent" },
        domain: { x: [0, 1], y: [0, 1] },
        xaxis: {title: 'Time'},
        yaxis: {title: 'Heart Rate (BPM)'},
      };
      var plotly_data = [
       { x: [], // Time on x-axis
        y: [], // BPM on y-axis
        type: 'scatter',
        mode: 'line+markers',
        name: 'Heart Rate (BPM)'
       }
      ];
      
      // Create initial plot (graph element)
      Plotly.newPlot(plotly_elem, plotly_data, plotly_layout);
       
      // Initialize indicator element
      const indicator_elem = document.getElementById('indicator_area');
      var default_value = 0;  // Initial default value for BPM
      var previous_value = default_value;  // Show also previous value 
      var indicator_data = [
        {
          type: "indicator",
          mode: "number+delta",
          value: default_value,
          delta: { position: "top", reference: previous_value },
          title: { text: "Heart Rate (BPM)" },
          domain: { x: [0, 1], y: [0, 1] }
        }
      ];
      var indicator_layout = { 
        margin: { t: 50, r: 50, l: 50, b: 50 }
      };

      // Create initial indicator
      Plotly.newPlot(indicator_elem, indicator_data, indicator_layout);

      /* DATA RETRIEVED FROM Micro:bit
    
      // Connect to Bluetooth
      // WRITE 
      
      // Obtain BPM data
      function handleBLENotifications(event) {
      let result = "";
      for (var i = 0; i < event.target.value.byteLength; i++) {
          result += String.fromCharCode(event.target.value.getUint8(i));
      }
      console.log(result);
      // From the Micro:bit we obtain 3 different values: only keep BPM value
      let individual_value = result.trim().split(/\s+/); // Separate the 3 different values
      let BPM_Value = individual_value[individual_value.length - 1]; // Keep the BPM
      }

      // Obtain current time
      let current_time = new Date().toLocaleTimeString();

      // Update values in plot - graph
      Plotly.extendTraces(plotly_elem, {
            x: [[current_time]],  // Time on x-axis
            y: [[BPM_Value]]     // BPM on y-axis
          }, [0]);
      
      // Update values in indicator
      Plotly.update(indicator_elem, {
            value: [BPM_value],  // Update the current value
            'delta.reference': [previous_value]  // Update the delta with previous value
          }, [0]);
          previous_value = BPM_value; // Update the previous value
      
          */

      // DATA RETRIEVED FROM FHIR
      
      // Import and Initialize FHIR

      // WRITE
      
      // Export data from FHIR

      async function getMyHRData() {
        const q = query(stepsRef, where("x", ">=", 1200));
        const querySnapshot = await getDocs(q);
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const current_time = new Date(data.timestamp)
          const BPM_Value = data.heartRate // CHECK NAME!
          
          console.log("Heart Rate", BPM_value, "at", current_time);
        
        });

        // Update values in plot - graph
        Plotly.extendTraces(plotly_elem, {
            x: [[current_time]],  // Time on x-axis
            y: [[BPM_Value]]     // BPM on y-axis
          }, [0]);
      
        // Update values in indicator
        Plotly.update(indicator_elem, {
            value: [BPM_value],  // Update the current value
            'delta.reference': [previous_value]  // Update the delta with previous value
          }, [0]);
          previous_value = BPM_value; // Update the previous value
      
      }

      getMyHRData();

    </script>
</body>
</html>
